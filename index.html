<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Approve Deposits & Withdraws | Echoplus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f3f4f6;
      color: #111827;
      padding: 20px;
    }

    h1 {
      margin-bottom: 20px;
      color: #1f2937;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .top-bar button {
      background: #3f37c9;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .card {
      background: #fff;
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .deposit { border-left: 5px solid #3f37c9; }
    .withdraw { border-left: 5px solid #f97316; }

    .card p {
      margin: 6px 0;
      font-size: 15px;
    }

    .approve-btn {
      background-color: #22c55e;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      margin-top: 10px;
      cursor: pointer;
    }

    .approve-btn:hover {
      background-color: #16a34a;
    }

    .section-title {
      margin-top: 40px;
      margin-bottom: 15px;
      font-size: 20px;
      color: #374151;
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }

    .no-items {
      text-align: center;
      font-size: 16px;
      color: #6b7280;
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <h1>Approve Deposits & Withdraws</h1>
    <button onclick="window.location.href='process earnings.html'">
      <i class="fas fa-coins"></i> Process Earnings
    </button>
  </div>

  <div class="section-title">Pending Deposits</div>
  <div id="depositList">Loading deposits...</div>

  <div class="section-title">Pending Withdraws</div>
  <div id="withdrawList">Loading withdraws...</div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyChCWhXOdNDl-8mc367bPmRBnNnVJsQVVU",
      authDomain: "echoplus-e9606.firebaseapp.com",
      projectId: "echoplus-e9606",
      storageBucket: "echoplus-e9606.appspot.com",
      messagingSenderId: "674979906304",
      appId: "1:674979906304:web:7864593a26f571a268a9e5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const depositList = document.getElementById("depositList");
    const withdrawList = document.getElementById("withdrawList");

    async function fetchDeposits() {
      const snapshot = await db.collection("deposits").where("status", "==", "pending").get();
      depositList.innerHTML = "";

      if (snapshot.empty) {
        depositList.innerHTML = "<p class='no-items'>No pending deposits found.or poor internet connection</p>";
        return;
      }

      for (const doc of snapshot.docs) {
        const deposit = doc.data();
        const userSnap = await db.collection("users").doc(deposit.userId).get();
        const user = userSnap.exists ? userSnap.data() : { name: "Unknown", phone: "N/A" };

        const div = document.createElement("div");
        div.className = "card deposit";
        div.innerHTML = `
          <p><strong>Amount:</strong> UGX ${deposit.amount.toLocaleString()}</p>
          <p><strong>Method:</strong> ${deposit.method}</p>
          <p><strong>Phone:</strong> ${deposit.phone}</p>
          <p><strong>Sim Card Owner:</strong> ${deposit.simCardOwner}</p>
          <p><strong>User:</strong> ${user.name} (${user.phone})</p>
          <p><strong>Status:</strong> ${deposit.status}</p>
          <button class="approve-btn" onclick="markDepositAsPaid('${doc.id}', ${deposit.amount}, '${deposit.userId}')">
            Mark as Paid
          </button>
        `;
        depositList.appendChild(div);
      }
    }

    async function fetchWithdraws() {
      const snapshot = await db.collection("withdraws").where("status", "==", "pending").get();
      withdrawList.innerHTML = "";

      if (snapshot.empty) {
        withdrawList.innerHTML = "<p class='no-items'>No pending withdraws found.Or poor internet connection</p>";
        return;
      }

      for (const doc of snapshot.docs) {
        const withdraw = doc.data();
        const userSnap = await db.collection("users").doc(withdraw.userId).get();
        const user = userSnap.exists ? userSnap.data() : { name: "Unknown", phone: "N/A" };

        const div = document.createElement("div");
        div.className = "card withdraw";
        div.innerHTML = `
          <p><strong>Amount:</strong> UGX ${withdraw.amount.toLocaleString()}</p>
          <p><strong>To Phone:</strong> ${withdraw.phone}</p>
          <p><strong>Holder:</strong> ${withdraw.holder}</p>
          <p><strong>User:</strong> ${user.name} (${user.phone})</p>
          <p><strong>Status:</strong> ${withdraw.status}</p>
          <button class="approve-btn" onclick="markWithdrawAsPaid('${doc.id}')">
            Mark as Paid
          </button>
        `;
        withdrawList.appendChild(div);
      }
    }

    async function markDepositAsPaid(depositId, amount, userId) {
      const confirmAction = confirm("Mark this deposit as paid?");
      if (!confirmAction) return;

      try {
        await db.collection("deposits").doc(depositId).update({ status: "paid" });

        const userRef = db.collection("users").doc(userId);
        const userSnap = await userRef.get();
        const userData = userSnap.exists ? userSnap.data() : {};

        const newTotalDeposit = (userData.totalDeposit || 0) + amount;
        const newUninvestedDeposit = (userData.uninvestedDeposit || 0) + amount;

        await userRef.update({
          totalDeposit: newTotalDeposit,
          uninvestedDeposit: newUninvestedDeposit
        });

        alert("Deposit marked as paid.");
        fetchDeposits();
      } catch (error) {
        console.error("Error approving deposit:", error);
        alert("Failed to approve deposit.");
      }
    }

    async function markWithdrawAsPaid(withdrawId) {
      const confirmAction = confirm("Mark this withdraw as paid?");
      if (!confirmAction) return;

      try {
        await db.collection("withdraws").doc(withdrawId).update({ status: "paid" });
        alert("Withdraw marked as paid.");
        fetchWithdraws();
      } catch (error) {
        console.error("Error approving withdraw:", error);
        alert("Failed to approve withdraw.");
      }
    }

    fetchDeposits();
    fetchWithdraws();
  </script>
  <script>
  const allowedAdmins = [
    "nuclearphillipsug@gmail.com",
    "byamukamambabazimentor2@gmail.com"
  ];

  const auth = firebase.auth();
  const loginTime = localStorage.getItem("adminLoginTime");

  auth.onAuthStateChanged(user => {
    if (!user || !allowedAdmins.includes(user.email)) {
      alert("❌ Access denied. Admins only.");
      window.location.href = "admin-login.html";
      return;
    }

    const now = Date.now();
    if (!loginTime || (now - parseInt(loginTime)) > 3600000) {
      auth.signOut().then(() => {
        localStorage.removeItem("adminLoginTime");
        alert("⏰ Session expired. Please log in again.");
        window.location.href = "admin-login.html";
      });
    }
  });
</script>
</body>
</html>