<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Distribute Daily Earnings - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f4f4;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 50px 20px;
    }

    h1 {
      color: #3f37c9;
      margin-bottom: 30px;
    }

    .btn {
      background-color: #28a745;
      color: white;
      padding: 12px 25px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    .btn:hover {
      background-color: #218838;
    }

    .btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .status {
      margin-top: 20px;
      font-size: 15px;
      color: #555;
      text-align: left;
      width: 100%;
      max-width: 600px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .success {
      color: #28a745;
    }

    .error {
      color: #dc3545;
    }

    .warning {
      color: #ffc107;
    }
  </style>
</head>
<body>

  <h1>Distribute Daily Earnings</h1>
  <button class="btn" id="processBtn" onclick="distributeEarnings()">
    <i class="fas fa-coins"></i> Distribute Earnings
  </button>
  <div class="status" id="statusMessage">Ready to process earnings...</div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyChCWhXOdNDl-8mc367bPmRBnNnVJsQVVU",
      authDomain: "echoplus-e9606.firebaseapp.com",
      projectId: "echoplus-e9606",
      storageBucket: "echoplus-e9606.appspot.com",
      messagingSenderId: "674979906304",
      appId: "1:674979906304:web:7864593a26f571a268a9e5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const processBtn = document.getElementById('processBtn');
    const statusEl = document.getElementById('statusMessage');

    // System document reference for tracking last processing time
    const systemRef = db.collection('system').doc('earningsProcessing');

    // Add log message with timestamp
    function log(message, type = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span>`;
      statusEl.appendChild(logEntry);
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    // Main function to distribute earnings
    async function distributeEarnings() {
      processBtn.disabled = true;
      log("Starting earnings distribution...");
      
      try {
        // Check last processing time
        const systemDoc = await systemRef.get();
        const now = new Date();
        
        if (systemDoc.exists) {
          const lastProcessed = systemDoc.data().lastProcessed.toDate();
          const hoursSinceLast = (now - lastProcessed) / (1000 * 60 * 60);
          
          if (hoursSinceLast < 24) {
            log(`‚ö†Ô∏è Earnings processed ${Math.floor(hoursSinceLast)} hours ago. Please wait ${Math.ceil(24 - hoursSinceLast)} more hours.`, "warning");
            processBtn.disabled = false;
            return;
          }
        }
        
        log("‚úÖ Last processing check passed");
        log("Fetching active products...");
             // Get all active products
        const productsSnapshot = await db.collection('products')
          .where('status', '==', 'active')
          .get();
        
        if (productsSnapshot.empty) {
          log("‚ÑπÔ∏è No active products found");
        } else {
          log(`Found ${productsSnapshot.size} active products`);
        }
        
        // Prepare for batch operations
        const userEarnings = {};
        const userUpdates = {};
        const earningsBatch = db.batch();
        const productsBatch = db.batch();
        const usersBatch = db.batch();
        
        // 1. Process products and calculate earnings
        productsSnapshot.forEach(doc => {
          const data = doc.data();
          const ref = doc.ref;
          const userId = data.userId;
          
          if (data.remainingDays > 0) {
            const earnToday = data.dailyIncome || 0;
            
            // Update product
            productsBatch.update(ref, {
              amountEarnedSoFar: (data.amountEarnedSoFar || 0) + earnToday,
              remainingDays: data.remainingDays - 1,
              lastEarningDate: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Mark as expired if cycles completed
            if (data.remainingDays === 1) {
              productsBatch.update(ref, { status: 'expired' });
              log(`‚ûñ Product ${doc.id} expired for user ${userId}`);
            }
            
            // Accumulate user earnings
            if (!userEarnings[userId]) {
              userEarnings[userId] = {
                daily: 0,
                welcome: false,
                referral: false
              };
            }
            userEarnings[userId].daily += earnToday;
          }
        });
        
        // Commit product updates
        await productsBatch.commit();
        log("‚úÖ Product updates completed");
        
        // 2. Process users
        log("Processing user earnings...");
        const usersSnapshot = await db.collection('users').get();
        
        usersSnapshot.forEach(userDoc => {
          const userRef = userDoc.ref;
          const userData = userDoc.data();
          const userId = userDoc.id;
          
          // Initialize user earnings if needed
          if (!userEarnings[userId]) {
            userEarnings[userId] = {
              daily: 0,
              welcome: !userData.welcomeBonusGiven,
              referral: false
            };
          }
          
          // Welcome bonus for new users (2000 UGX)
          if (!userData.welcomeBonusGiven) {
            userEarnings[userId].welcome = true;
            log(`üéÅ Added welcome bonus to user ${userId}`);
          }
          
          // Referral bonus (25% of referee's deposit)
          if (userData.referrer && !userData.referrerAwarded && userData.totalDeposit > 0) {
            const referrerId = userData.referrer;
            const referralBonus = userData.totalDeposit * 0.25;
            
            if (!userEarnings[referrerId]) {
              userEarnings[referrerId] = {
                daily: 0,
                welcome: false,
                referral: true,
                referralAmount: referralBonus,
                referralFrom: userId
              };
            } else {
              userEarnings[referrerId].referral = true;
              userEarnings[referrerId].referralAmount = referralBonus;
              userEarnings[referrerId].referralFrom = userId;
            }
            
            // Mark referral as awarded
            usersBatch.update(userRef, { referrerAwarded: true });
            log(`üë• Added referral bonus of UGX ${referralBonus} to ${referrerId} from ${userId}`);
          }
          
          // Prepare user updates
          const earnings = userEarnings[userId];
          const updates = {};
          
          if (earnings.daily > 0) {
            updates.totalEarnings = (userData.totalEarnings || 0) + earnings.daily;
            updates.todaysEarnings = earnings.daily;
          }
          
          if (earnings.welcome) {
            updates.uninvestedDeposit = (userData.uninvestedDeposit || 0) + 2000;
            updates.welcomeBonusGiven = true;
          }
          
          if (earnings.referral) {
            updates.uninvestedDeposit = (userData.uninvestedDeposit || 0) + earnings.referralAmount;
          }
          
          // Count active investments
          if (userData.activeInvestments === undefined) {
            updates.activeInvestments = 0;
          }
          
          if (Object.keys(updates).length > 0) {
            usersBatch.update(userRef, updates);
          }
        });
        
        // Commit user updates
        await usersBatch.commit();
        log("‚úÖ User updates completed");
        
        // 3. Create earnings records
        log("Creating earnings records...");
        const earningsCollection = db.collection('earnings');
        const earningsTimestamp = firebase.firestore.FieldValue.serverTimestamp();
        
        for (const userId in userEarnings) {
          const earnings = userEarnings[userId];
          
          if (earnings.daily > 0) {
            earningsBatch.set(earningsCollection.doc(), {
              userId: userId,
              amount: earnings.daily,
              type: 'daily',
              date: earningsTimestamp
            });
          }
          
          if (earnings.welcome) {
            earningsBatch.set(earningsCollection.doc(), {
              userId: userId,
              amount: 2000,
              type: 'welcome',
              date: earningsTimestamp
            });
          }
          
          if (earnings.referral) {
            earningsBatch.set(earningsCollection.doc(), {
              userId: userId,
              amount: earnings.referralAmount,
              type: 'referral',
              date: earningsTimestamp,
              referralFrom: earnings.referralFrom
            });
          }
        }
        
        await earningsBatch.commit();
        log("‚úÖ Earnings records created");
        
        // 4. Update last processing time
        await systemRef.set({
          lastProcessed: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        log("üéâ Earnings distribution completed successfully!", "success");
      } catch (err) {
        console.error("Error:", err);
        log(`‚ùå ERROR: ${err.message}`, "error");
      } finally {
        processBtn.disabled = false;
      }
    }
  </script>
</body>
</html>