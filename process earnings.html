<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Distribute Daily Product Earnings - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f4f4;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 50px 20px;
    }

    h1 {
      color: #3f37c9;
      margin-bottom: 30px;
    }

    .btn {
      background-color: #28a745;
      color: white;
      padding: 12px 25px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    .btn:hover {
      background-color: #218838;
    }

    .btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .status {
      margin-top: 20px;
      font-size: 15px;
      color: #555;
      text-align: left;
      width: 100%;
      max-width: 600px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .success {
      color: #28a745;
    }

    .error {
      color: #dc3545;
    }

    .warning {
      color: #ffc107;
    }

    table {
      margin-top: 40px;
      width: 100%;
      max-width: 600px;
      background: white;
      border-collapse: collapse;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #0056cc;
      color: white;
    }

    td {
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h1>Distribute Daily Product Earnings</h1>
  <button class="btn" id="processBtn" onclick="distributeEarnings()">
    <i class="fas fa-coins"></i> Distribute Product Earnings
  </button>
  <div class="status" id="statusMessage">Ready to process product earnings...</div>

  <!-- Earnings Table -->
  <h2 style="margin-top: 40px;">Recent Product Earnings</h2>
  <table id="earningsTable">
    <thead>
      <tr>
        <th>Type</th>
        <th>Phone</th>
        <th>Amount (UGX)</th>
      </tr>
    </thead>
    <tbody id="earningsBody">
      <tr><td colspan="3" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyChCWhXOdNDl-8mc367bPmRBnNnVJsQVVU",
      authDomain: "echoplus-e9606.firebaseapp.com",
      projectId: "echoplus-e9606",
      storageBucket: "echoplus-e9606.appspot.com",
      messagingSenderId: "674979906304",
      appId: "1:674979906304:web:7864593a26f571a268a9e5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const processBtn = document.getElementById('processBtn');
    const statusEl = document.getElementById('statusMessage');
    const systemRef = db.collection('system').doc('earningsProcessing');

    function log(message, type = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span>`;
      statusEl.appendChild(logEntry);
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    async function distributeEarnings() {
      processBtn.disabled = true;
      log("Starting product earnings distribution...");

      try {
        const systemDoc = await systemRef.get();
        const now = new Date();

        if (systemDoc.exists) {
          const lastProcessed = systemDoc.data().lastProcessed.toDate();
          const hoursSinceLast = (now - lastProcessed) / (1000 * 60 * 60);

          if (hoursSinceLast < 24) {
            log(`‚ö†Ô∏è Earnings processed ${Math.floor(hoursSinceLast)} hours ago. Wait ${Math.ceil(24 - hoursSinceLast)} more hours.`, "warning");
            processBtn.disabled = false;
            return;
          }
        }

        log("‚úÖ Last processing check passed");
        let processedCount = 0;

        const usersSnap = await db.collection('users').get();

        for (const userDoc of usersSnap.docs) {
          const userData = userDoc.data();
          const userId = userDoc.id;

          if (userData.productEarnings && userData.productEarnings > 0) {
            const earningAmount = userData.productEarnings;

            // Add earning to earnings collection
            await db.collection('earnings').add({
              userId: userId,
              amount: earningAmount,
              type: 'product',
              date: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Reset product earnings to 0
            await db.collection('users').doc(userId).update({
              productEarnings: 0
            });

            log(`üí∞ UGX ${earningAmount} product earnings sent to ${userData.phone || 'user'}`);
            processedCount++;
          }
        }

        log(`üéâ Distribution done for ${processedCount} user(s).`, "success");

        await systemRef.set({ lastProcessed: firebase.firestore.FieldValue.serverTimestamp() });

        loadRecentEarnings();
      } catch (err) {
        console.error("Error:", err);
        log(`‚ùå ERROR: ${err.message}`, "error");
      } finally {
        processBtn.disabled = false;
      }
    }

    async function loadRecentEarnings() {
      const earningsBody = document.getElementById("earningsBody");
      earningsBody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Loading...</td></tr>";

      try {
        const earningsSnap = await db.collection('earnings')
          .where('type', '==', 'product')
          .orderBy('date', 'desc')
          .limit(20)
          .get();

        const usersSnap = await db.collection('users').get();
        const userPhoneMap = {};
        usersSnap.forEach(doc => {
          const data = doc.data();
          userPhoneMap[doc.id] = data.phone || 'N/A';
        });

        let rows = '';
        earningsSnap.forEach(doc => {
          const data = doc.data();
          const phone = userPhoneMap[data.userId] || 'Unknown';
          rows += `
            <tr>
              <td>${data.type}</td>
              <td>${phone}</td>
              <td>UGX ${data.amount}</td>
            </tr>
          `;
        });

        earningsBody.innerHTML = rows || "<tr><td colspan='3' style='text-align:center;'>No earnings found.</td></tr>";
      } catch (error) {
        console.error("Error loading earnings:", error);
        earningsBody.innerHTML = "<tr><td colspan='3' style='text-align:center; color:red;'>Failed to load earnings.</td></tr>";
      }
    }

    window.onload = () => {
      loadRecentEarnings();
    };
  </script>

  <!-- Admin Login Control -->
  <script>
    const allowedAdmins = [
      "nuclearphillipsug@gmail.com",
      "byamukamambabazimentor2@gmail.com"
    ];

    const auth = firebase.auth();
    const loginTime = localStorage.getItem("adminLoginTime");

    auth.onAuthStateChanged(user => {
      if (!user || !allowedAdmins.includes(user.email)) {
        alert("‚ùå Access denied. Admins only.");
        window.location.href = "login.html";
        return;
      }

      const now = Date.now();
      if (!loginTime || (now - parseInt(loginTime)) > 3600000) {
        auth.signOut().then(() => {
          localStorage.removeItem("adminLoginTime");
          alert("‚è∞ Session expired. Please log in again.");
          window.location.href = "login.html";
        });
      }
    });
  </script>
</body>
</html>